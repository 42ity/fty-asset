#!/bin/bash

# TODO: GPL

# Tool to setup routing on 42ity
# Author: Michal Vyskocil <michalvyskocil@eaton.com>
#

die () {
    echo "FATAL: ${@}" >&2
    exit 1
}

# Execute augtool with given arguments
augtool () {

    if [[ "${1}" == "set" ]]; then
        cat <<EOF | /usr/bin/sudo /usr/bin/augtool -S -I/usr/share/fty/lenses/
"${1}" "${2}" "${3}"
save
EOF
    elif [[ "${1}" == "rm" ]]; then
        cat <<EOF | /usr/bin/sudo /usr/bin/augtool -S -I/usr/share/fty/lenses/
"${1}" "${2}"
save
EOF
    else
        /usr/bin/sudo /usr/bin/augtool -S -I/usr/share/fty/lenses/ "${@}"
    fi
}

# Return augeas index
ag_index () {
    local cmd pattern
    cmd=${1}
    pattern=${2}

    augtool "${cmd}" | grep "= ${pattern}$" | cut -d '=' -f 1 | sed 's/ //g'
}

### MAIN ###
COMMAND=${@}
ARGS=("${@}")
LAST_IDX=$((${#} - 1))

# TODO: check add/del commands

# put all routing to the default interface, unless (dev)? iface_name is specified
# distinguish modes by checking last argument of post-up
IFACE_PATH=$(ag_index "match /files/etc/network/interfaces/iface[*]" "${ARGS[${LAST_IDX}]}")
if [[ -z "${IFACE_PATH}" ]]; then
    # iface[0] is lo
    IFACE_PATH="/files/etc/network/interfaces/iface[1]"
fi

#TODO: ^^^ tested until now!

case ${ARGS[0]} in
    list)
        /sbin/route
        ;;
    add)
        augtool "set" "${IFACE_PATH}/post-up[last()+1]" "route ${COMMAND}"
        ;;
    del)
        POST_UP_PATH=$(ag_index "match ${IFACE_PATH}/post-up" "route ${COMMAND/del/add}")
        if [ -z "${POST_UP_PATH}" ]; then
            die "Can't delete non existent route ${COMMAND} from ${IFACE_PATH}"
        fi
        for line in ${POST_UP_PATH}; do
            augtool "rm" "${line}"
        done
        ;;
    -h|--help|help)
        cat <<EOF >&2
Usage: fty-rest [list|add|del] ... routing details

        Manipulates with routing table of network interfaces. It writes to
        /etc/network/interfaces, so all changes are persistent.

        list - print kernel routing table

        add - add new route, by default to the first network device.
        Last parameter can specify network device to use.

        del - delete matching line from interfaces file
        Last parameter can specify network device to use.

EXAMPLES:
        Add new route for first network device

        fty-route add -net 10.41.0.0/16 gw 192.168.0.1

        Add new route for specific device
        fty-route add -net 10.41.0.0/16 gw 192.168.0.1 (dev)? LAN3

        Remove route
        fty-route del -net 10.41.0.0/16 gw 192.168.0.1

        Remove route for specific device
        fty-route del -net 10.41.0.0/16 gw 192.168.0.1 LAN3
EOF
        exit 1
        ;;
    *)
        die "Unknown command ${ARGS[0]}, use add/del"
esac
